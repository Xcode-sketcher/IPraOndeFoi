<div class="fixed inset-0 z-[100] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" (click)="closeModal()"></div>

    <div
        class="relative w-full max-w-2xl bg-(--surface-strong) rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-[scaleIn_0.2s_ease-out]">

        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-(--border-subtle)">
            <h2 class="text-xl font-bold text-(--text-primary)">Configura√ß√µes</h2>
            <button (click)="closeModal()" class="p-2 rounded-full hover:bg-(--surface-muted) text-(--text-secondary)">
                ‚úï
            </button>
        </div>

        <!-- Layout -->
        <div class="flex flex-col md:flex-row flex-1 overflow-hidden">

            <!-- Sidebar Tabs -->
            <div
                class="p-4 bg-(--surface) border-r border-(--border-subtle) flex flex-row md:flex-col gap-2 overflow-x-auto md:overflow-visible">
                <button (click)="setTab('perfil')"
                    class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold transition-all whitespace-nowrap"
                    [class.bg-emerald-500]="activeTab() === 'perfil'" [class.text-white]="activeTab() === 'perfil'"
                    [class.bg-transparent]="activeTab() !== 'perfil'"
                    [class.text-(--text-secondary)]="activeTab() !== 'perfil'"
                    [class.hover:bg-(--surface-muted)]="activeTab() !== 'perfil'">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
                        <circle cx="12" cy="7" r="4" />
                    </svg> Perfil
                </button>
                <button (click)="setTab('tags')"
                    class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold transition-all whitespace-nowrap"
                    [class.bg-emerald-500]="activeTab() === 'tags'" [class.text-white]="activeTab() === 'tags'"
                    [class.bg-transparent]="activeTab() !== 'tags'"
                    [class.text-(--text-secondary)]="activeTab() !== 'tags'"
                    [class.hover:bg-(--surface-muted)]="activeTab() !== 'tags'">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z" />
                        <path d="M7 7h.01" />
                    </svg> Tags
                </button>
                <button (click)="setTab('sistema')"
                    class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold transition-all whitespace-nowrap"
                    [class.bg-emerald-500]="activeTab() === 'sistema'" [class.text-white]="activeTab() === 'sistema'"
                    [class.bg-transparent]="activeTab() !== 'sistema'"
                    [class.text-(--text-secondary)]="activeTab() !== 'sistema'"
                    [class.hover:bg-(--surface-muted)]="activeTab() !== 'sistema'">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                        <circle cx="12" cy="12" r="3" />
                    </svg> Sistema
                </button>
            </div>

            <!-- Main Content -->
            <div class="flex-1 p-6 overflow-y-auto">

                <!-- Perfil -->
                <div *ngIf="activeTab() === 'perfil'" class="animate-[fadeIn_0.2s_ease-out] space-y-6">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-20 h-20 rounded-full bg-gradient-to-tr from-emerald-400 to-cyan-500 flex items-center justify-center text-3xl text-white font-bold shadow-lg">
                            {{ (user()?.email?.charAt(0) ?? 'U').toUpperCase() }}
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-(--text-primary)">Usu√°rio</h3>
                            <p class="text-(--text-secondary)">{{ user()?.email }}</p>
                        </div>
                    </div>

                    <div class="pt-6 border-t border-(--border-subtle)">
                        <button (click)="logout()" [disabled]="isLoggingOut()"
                            class="w-full py-3 rounded-xl border border-red-200 text-red-600 font-semibold hover:bg-red-50 transition-colors disabled:opacity-50">
                            {{ isLoggingOut() ? 'Saindo...' : 'Sair da Conta' }}
                        </button>
                    </div>
                </div>

                <!-- Tags -->
                <div *ngIf="activeTab() === 'tags'"
                    class="animate-[fadeIn_0.2s_ease-out] space-y-6 h-full flex flex-col">

                    <!-- Success -->
                    <div *ngIf="tagSuccess()"
                        class="p-3 rounded-xl bg-emerald-50 text-emerald-600 border border-emerald-100 text-sm flex items-center gap-2">
                        ‚úÖ {{ tagSuccess() }}
                    </div>

                    <!-- Error -->
                    <div *ngIf="tagError()"
                        class="p-3 rounded-xl bg-red-50 text-red-600 border border-red-100 text-sm flex items-center gap-2">
                        ‚ö†Ô∏è {{ tagError() }}
                    </div>

                    <!-- Add Tag -->
                    <div class="flex gap-2">
                        <input [ngModel]="newTagName()" (ngModelChange)="newTagName.set($event)"
                            (keydown)="handleKeydown($event)" type="text" placeholder="Nome da nova tag..."
                            class="flex-1 rounded-xl border border-(--border-subtle) bg-(--surface) px-4 py-2 text-(--text-primary) outline-none focus:border-emerald-500">
                        <button (click)="addTag()" [disabled]="!newTagName() || isAddingTag()"
                            class="px-5 py-2 rounded-xl bg-emerald-500 text-white font-bold hover:bg-emerald-600 disabled:opacity-50 transition-all">
                            {{ isAddingTag() ? '...' : '+' }}
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto">
                        <div *ngIf="isLoadingTags()" class="text-center py-4 text-(--text-tertiary)">Carregando...</div>

                        <div *ngIf="!isLoadingTags() && tags().length === 0"
                            class="text-center py-8 text-(--text-tertiary) bg-(--surface) rounded-2xl border border-dashed border-(--border-subtle)">
                            Nenhuma tag criada. Adicione sua primeira tag acima.
                        </div>

                        <div class="flex flex-wrap gap-2 content-start">
                            <div *ngFor="let tag of tags()"
                                class="group flex items-center gap-2 px-3 py-1.5 rounded-full bg-(--surface-muted) text-sm text-(--text-primary) border border-transparent hover:border-emerald-200 transition-colors">
                                <span># {{ tag.nome }}</span>
                                <button (click)="openDeleteTagModal(tag)"
                                    class="w-5 h-5 rounded-full flex items-center justify-center hover:bg-red-100 text-(--text-tertiary) hover:text-red-500 transition-colors">√ó</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sistema -->
                <div *ngIf="activeTab() === 'sistema'" class="animate-[fadeIn_0.2s_ease-out] space-y-6">

                    <!-- Dark Mode Toggle -->
                    <div>
                        <h3 class="font-bold text-(--text-primary) mb-4">Apar√™ncia</h3>
                        <button (click)="theme.toggle()"
                            class="w-full p-4 rounded-xl border border-(--border-subtle) flex items-center justify-between hover:bg-(--surface-muted) transition-all">
                            <span class="font-medium text-(--text-primary)">Modo Escuro</span>
                            <div class="w-12 h-6 rounded-full bg-(--surface-muted) border border-(--border-subtle) relative transition-colors"
                                [class.bg-emerald-500]="theme.isDark()" [class.border-emerald-600]="theme.isDark()">
                                <div class="w-4 h-4 rounded-full bg-white absolute top-1 transition-all shadow-sm"
                                    [class.left-1]="!theme.isDark()" [class.left-7]="theme.isDark()"></div>
                            </div>
                        </button>
                        <p class="text-xs text-(--text-secondary) mt-2 px-1">Alternar entre tema claro e escuro.</p>
                    </div>

                    <!-- PWA Install Section -->
                    <div class="pt-6 border-t border-(--border-subtle)">
                        <h3 class="font-bold text-(--text-primary) mb-4 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <rect height="18" rx="2" ry="2" width="12" x="6" y="2" />
                                <line x1="12" x2="12" y1="18" y2="18" />
                            </svg> Instalar App
                        </h3>

                        <!-- Already Installed -->
                        <div *ngIf="pwa.isInstalled()"
                            class="p-4 rounded-xl bg-emerald-50 border border-emerald-100 text-center">
                            <div class="text-3xl mb-2 flex justify-center text-emerald-600"><svg
                                    xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                                    <polyline points="22 4 12 14.01 9 11.01" />
                                </svg></div>
                            <p class="font-semibold text-emerald-600">App j√° instalado!</p>
                            <p class="text-sm text-emerald-500 mt-1">Voc√™ est√° usando o PraOndeFoi como app.</p>
                        </div>

                        <!-- Can Install -->
                        <div *ngIf="pwa.canInstall() && !pwa.isInstalled()">
                            <button (click)="installPwa()" [disabled]="isInstalling()"
                                class="w-full py-4 rounded-xl bg-gradient-to-r from-emerald-500 to-cyan-500 font-bold text-white shadow-lg hover:scale-[1.02] transition-all disabled:opacity-50">
                                <span class="flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242" />
                                        <path d="M12 12v9" />
                                        <path d="m8 17 4 4 4-4" />
                                    </svg>
                                    {{ isInstalling() ? 'Instalando...' : 'Instalar PraOndeFoi' }}
                                </span>
                            </button>
                            <p class="text-xs text-(--text-secondary) mt-2 text-center">Acesse offline e com √≠cone na
                                tela inicial.</p>
                        </div>

                        <!-- Cannot Install (Show Manual Instructions) -->
                        <div *ngIf="!pwa.canInstall() && !pwa.isInstalled()">
                            <div class="p-4 rounded-xl bg-(--surface) border border-(--border-subtle)">
                                <p class="font-semibold text-(--text-primary) mb-2">Instalar Manualmente</p>
                                <p class="text-sm text-(--text-secondary)">{{ pwa.getManualInstallInstructions() }}</p>
                            </div>
                        </div>

                        <!-- Install Message -->
                        <div *ngIf="installMessage()"
                            class="mt-3 p-3 rounded-xl bg-blue-50 text-blue-600 border border-blue-100 text-sm text-center">
                            {{ installMessage() }}
                        </div>
                    </div>

                    <!-- Version -->
                    <div class="pt-6 border-t border-(--border-subtle)">
                        <p class="text-xs text-(--text-tertiary) text-center">Vers√£o 2.3.0 (PWA) üöÄ</p>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<!-- Delete Tag Confirmation Modal -->
<div *ngIf="isDeleteTagModalOpen()" class="fixed inset-0 z-[110] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" (click)="closeDeleteTagModal()"></div>
    <div
        class="relative w-full max-w-sm rounded-3xl bg-(--surface-strong) p-6 shadow-2xl animate-[fadeIn_0.2s_ease-out] text-center">

        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-100 flex items-center justify-center text-3xl">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="text-red-600">
                <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z" />
                <path d="M7 7h.01" />
            </svg>
        </div>

        <h2 class="text-xl font-bold text-(--text-primary) mb-2">Excluir Tag?</h2>
        <p class="text-sm text-(--text-secondary) mb-6">
            Deseja excluir a tag <strong>#{{ deletingTag()?.nome }}</strong>?
        </p>

        <div class="flex gap-3">
            <button (click)="closeDeleteTagModal()"
                class="flex-1 py-3 rounded-xl font-semibold text-(--text-secondary) hover:bg-(--surface-muted) border border-(--border-subtle)">
                Cancelar
            </button>
            <button (click)="confirmDeleteTag()" [disabled]="isDeletingTag()"
                class="flex-1 py-3 rounded-xl bg-red-500 font-semibold text-white hover:bg-red-600 disabled:opacity-50">
                {{ isDeletingTag() ? 'Excluindo...' : 'Excluir' }}
            </button>
        </div>
    </div>
</div>